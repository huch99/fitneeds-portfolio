<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.ticket.mapper.PassUsageStatsMapper">

    <select id="selectPassStatusStats" resultType="com.project.app.ticket.dto.PassUsageStatsDto">
        SELECT
            pass_status_cd AS statusCd,
            COUNT(*) AS userCount,
            NULL AS chgTypeCd,
            0 AS totalChgCnt,
            AVG((init_cnt - rmn_cnt) / NULLIF(DATEDIFF(NOW(), reg_dt), 0)) AS avgDepletionRate
        FROM USER_PASS
        GROUP BY pass_status_cd
    </select>

    <select id="selectPassLogStats" resultType="com.project.app.ticket.dto.PassUsageStatsDto">
        SELECT
            NULL AS statusCd,
            COUNT(DISTINCT user_pass_id) AS userCount,
            chg_type_cd AS chgTypeCd,
            SUM(ABS(chg_cnt)) AS totalChgCnt,
            0.0 AS avgDepletionRate
        FROM PASS_LOG
        WHERE DATE(reg_dt) BETWEEN #{startDate} AND #{endDate}
        GROUP BY chg_type_cd
    </select>


</mapper>