<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.community.mapper.AdminCommunityMapper">

  <!-- ‚úÖ ADMIN Ïª§ÎÆ§ÎãàÌã∞ Î™©Î°ù (Í≤ÄÏÉâ + Ï†ïÎ†¨ + ÎåìÍ∏ÄÏàò + ÌéòÏù¥Ïßï)
       - Í∏∞Î≥∏: Ïà®ÍπÄÍ∏Ä Ìè¨Ìï® Ï†ÑÏ≤¥ Ï°∞Ìöå
       - post_visibleÏùÄ ÏÉÅÌÉúÍ∞íÏúºÎ°úÎßå ÏÇ¨Ïö© (ÌïÑÌÑ∞ ÏïÑÎãò)
  -->
  <select id="selectCommunityPostList"
          resultType="com.project.app.community.dto.CommunityPostDto">

    SELECT
      p.*,
      COUNT(c.comment_id) AS commentCount
    FROM community_post p
    LEFT JOIN community_comment c
      ON p.post_id = c.post_id
     AND c.comment_visible = 1

   <where>
  AND p.post_type = 'COMMUNITY'

  <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Î™ÖÏãúÏ†ÅÏúºÎ°ú ÏÑ†ÌÉùÌïú Í≤ΩÏö∞ -->
  <if test="category != null and category != ''">
    AND p.category = #{category}
  </if>

  <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÎØ∏ÏÑ†ÌÉù Ïãú Í∞úÏù∏Ï†ïÎ≥¥ÎèôÏùò Ï†úÏô∏ -->
  <if test="category == null or category == ''">
    AND p.category != 'Í∞úÏù∏Ï†ïÎ≥¥ÎèôÏùò'
  </if>

  <if test="keyword != null and keyword != ''">
    AND p.title LIKE CONCAT('%', #{keyword}, '%')
  </if>

  <if test="visible != null">
    AND p.post_visible = #{visible}
  </if>
</where>


    GROUP BY p.post_id

    <choose>
      <when test="orderType == 'views'">
        ORDER BY p.views DESC
      </when>
      <when test="orderType == 'comments'">
        ORDER BY commentCount DESC
      </when>
      <otherwise>
        ORDER BY p.created_at DESC
      </otherwise>
    </choose>

    LIMIT #{limit} OFFSET #{offset}

  </select>

  <!-- ‚úÖ ADMIN Ïª§ÎÆ§ÎãàÌã∞ Ï†ÑÏ≤¥ Í±¥Ïàò (ÌéòÏù¥ÏßïÏö©) -->
  <select id="selectCommunityPostCount" resultType="int">
    SELECT COUNT(DISTINCT p.post_id)
    FROM community_post p
    LEFT JOIN community_comment c
      ON p.post_id = c.post_id
     AND c.comment_visible = 1

    <where>
      AND p.post_type = 'COMMUNITY'

      <if test="category != null and category != ''">
        AND p.category = #{category}
      </if>

      <if test="keyword != null and keyword != ''">
        AND p.title LIKE CONCAT('%', #{keyword}, '%')
      </if>

      <!-- üîπ ÌôïÏû•Ïö© ÌïÑÌÑ∞ -->
      <if test="visible != null">
        AND p.post_visible = #{visible}
      </if>
    </where>
  </select>

  <!-- ‚úÖ ADMIN Ïª§ÎÆ§ÎãàÌã∞ Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå -->
  <select id="selectCommunityPostDetail"
          resultType="com.project.app.community.dto.CommunityPostDto">
    SELECT p.*
    FROM community_post p
    WHERE p.post_id = #{postId}
      AND p.post_type = 'COMMUNITY'
  </select>

  <!-- ‚úÖ Ïà®ÍπÄ / Î≥¥Ïù¥Í∏∞ -->
  <update id="updatePostVisible">
    UPDATE community_post
    SET post_visible = #{postVisible},
        updated_at = NOW()
    WHERE post_id = #{postId}
      AND post_type = 'COMMUNITY'
  </update>

  <!-- ‚úÖ ÏÇ≠Ï†ú -->
  <delete id="deleteCommunityPost">
    DELETE FROM community_post
    WHERE post_id = #{postId}
      AND post_type = 'COMMUNITY'
  </delete>


<!--
	<where>
      AND p.post_type = 'COMMUNITY'

      <if test="category != null and category != ''">
        AND p.category = #{category}
      </if>

      <if test="keyword != null and keyword != ''">
        AND p.title LIKE CONCAT('%', #{keyword}, '%')
      </if>

      
      <if test="visible != null">
        AND p.post_visible = #{visible}
      </if>
    </where>
	
-->

</mapper>
