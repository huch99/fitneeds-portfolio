<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.schedule.mapper.ScheduleMapper">

    <resultMap id="ScheduleResultMap" type="com.project.app.schedule.domain.Schedule">
        <id property="schdId" column="schd_id" />
        <result property="brchId" column="brch_id" />
        <result property="progId" column="prog_id" />
        <result property="userId" column="user_id" />
        <result property="strtDt" column="strt_dt" />
        <result property="strtTm" column="strt_tm" />
        <result property="endTm" column="end_tm" />
        <result property="maxNopCnt" column="max_nop_cnt" />
        <result property="rsvCnt" column="rsv_cnt" />
        <result property="sttsCd" column="stts_cd" javaType="com.project.app.schedule.entity.ScheduleSttsCd" jdbcType="VARCHAR" typeHandler="org.apache.ibatis.type.EnumTypeHandler" />
        <result property="description" column="description" />
        <result property="regDt" column="reg_dt" />
        <result property="updDt" column="upd_dt" />
    </resultMap>

    <!-- =========================
         스케줄 전체 조회
    ========================= -->
    <select id="findAll"
            resultMap="ScheduleResultMap">
        SELECT
            schd_id,
            brch_id,
            prog_id,
            user_id,
            strt_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        FROM SCHEDULE
        ORDER BY strt_dt DESC, strt_tm ASC
    </select>

    <!-- =========================
         스케줄 ID로 조회
    ========================= -->
    <select id="findById"
            parameterType="java.lang.Long"
            resultMap="ScheduleResultMap">
        SELECT
            schd_id,
            brch_id,
            prog_id,
            user_id,
            strt_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        FROM SCHEDULE
        WHERE schd_id = #{schdId}
    </select>

    <!-- =========================
         스케줄 생성
    ========================= -->
    <insert id="insert"
            parameterType="com.project.app.schedule.domain.Schedule"
            useGeneratedKeys="true"
            keyProperty="schdId">
        INSERT INTO SCHEDULE (
            brch_id,
            prog_id,
            user_id,
            strt_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        ) VALUES (
            #{brchId},
            #{progId},
            #{userId},
            #{strtDt},
            #{strtTm},
            #{endTm},
            #{maxNopCnt},
            #{rsvCnt},
            #{sttsCd, jdbcType=VARCHAR, javaType=com.project.app.schedule.entity.ScheduleSttsCd, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            #{description},
            #{regDt},
            #{updDt}
        )
    </insert>

    <!-- =========================
         스케줄 수정
    ========================= -->
    <update id="update"
            parameterType="com.project.app.schedule.domain.Schedule">
        UPDATE SCHEDULE
        SET
            brch_id = #{brchId},
            prog_id = #{progId},
            user_id = #{userId},
            strt_dt = #{strtDt},
            strt_tm = #{strtTm},
            end_tm = #{endTm},
            max_nop_cnt = #{maxNopCnt},
            stts_cd = #{sttsCd, jdbcType=VARCHAR, javaType=com.project.app.schedule.entity.ScheduleSttsCd, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            description = #{description},
            upd_dt = #{updDt}
        WHERE schd_id = #{schdId}
    </update>

    <!-- =========================
         스케줄 삭제
    ========================= -->
    <delete id="delete"
            parameterType="long">
        DELETE FROM SCHEDULE
        WHERE schd_id = #{schdId}
    </delete>

    <!-- =========================
         중복 체크 (같은 날짜, 시간, 프로그램, 강사)
    ========================= -->
    <select id="countDuplicate"
            resultType="int">
        SELECT COUNT(*)
        FROM SCHEDULE
        WHERE prog_id = #{progId}
          AND user_id = #{userId}
          AND strt_dt = #{strtDt}
          AND (
            (strt_tm &lt; #{endTm} AND end_tm &gt; #{strtTm})
          )
          <if test="excludeSchdId != null">
            AND schd_id != #{excludeSchdId}
          </if>
    </select>

    <!-- =========================
         스케줄이 있는 날짜 목록 조회 (전체)
    ========================= -->
    <select id="selectDistinctScheduleDates"
            resultType="java.time.LocalDate">
        SELECT DISTINCT strt_dt
        FROM SCHEDULE
        ORDER BY strt_dt
    </select>

    <!-- =========================
         스케줄이 있는 날짜 목록 조회 (스포츠 종목별)
    ========================= -->
    <select id="selectDistinctScheduleDatesBySportId"
            resultType="java.time.LocalDate">
        SELECT DISTINCT s.strt_dt
        FROM SCHEDULE s
        INNER JOIN PROGRAM p ON s.prog_id = p.prog_id
        WHERE p.sport_id = #{sportId}
        ORDER BY s.strt_dt
    </select>

    <!-- =========================
         특정 날짜의 스케줄 조회 (ScheduleResponse)
    ========================= -->
    <select id="selectSchedulesByDate"
            resultType="com.project.app.schedule.dto.ScheduleResponse">
        SELECT
            s.schd_id as schdId,
            p.prog_nm as programName,
            u.user_name as instructorName,
            s.strt_tm as strtTm,
            s.end_tm as endTm,
            s.max_nop_cnt as maxNopCnt,
            s.rsv_cnt as rsvCnt,
            s.stts_cd as sttsCd
        FROM SCHEDULE s
        LEFT JOIN PROGRAM p ON s.prog_id = p.prog_id
        LEFT JOIN SPORT_TYPE sp ON p.sport_id = sp.sport_id
        LEFT JOIN BRANCH b ON s.brch_id = b.brch_id
        LEFT JOIN USERS u ON s.user_id = u.user_id
        WHERE s.strt_dt = #{date}
        ORDER BY s.strt_tm
    </select>

</mapper>

