<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.schedule.mapper.ScheduleMapper">

    <resultMap id="ScheduleResultMap" type="com.project.app.schedule.domain.Schedule">
        <id property="schdId" column="schd_id" />
        <result property="brchId" column="brch_id" />
        <result property="progId" column="prog_id" />
        <result property="usrId" column="usr_id" />
        <result property="strtDt" column="strt_dt" />
        <result property="endDt" column="end_dt" />
        <result property="strtTm" column="strt_tm" />
        <result property="endTm" column="end_tm" />
        <result property="maxNopCnt" column="max_nop_cnt" />
        <result property="rsvCnt" column="rsv_cnt" />
        <result property="sttsCd" column="stts_cd" />
        <result property="description" column="description" />
        <result property="regDt" column="reg_dt" />
        <result property="updDt" column="upd_dt" />
    </resultMap>

    <!-- =========================
         스케줄 전체 조회
    ========================= -->
    <select id="findAll"
            resultMap="ScheduleResultMap">
        SELECT
            schd_id,
            brch_id,
            prog_id,
            usr_id,
            strt_dt,
            end_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        FROM schedule
        ORDER BY strt_dt DESC, strt_tm ASC
    </select>

    <!-- =========================
         스케줄 ID로 조회
    ========================= -->
    <select id="findById"
            parameterType="java.lang.Long"
            resultMap="ScheduleResultMap">
        SELECT
            schd_id,
            brch_id,
            prog_id,
            usr_id,
            strt_dt,
            end_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        FROM schedule
        WHERE schd_id = #{schdId}
    </select>

    <!-- =========================
         스케줄 생성
    ========================= -->
    <insert id="insert"
            parameterType="com.project.app.schedule.domain.Schedule"
            useGeneratedKeys="true"
            keyProperty="schdId">
        INSERT INTO schedule (
            brch_id,
            prog_id,
            usr_id,
            strt_dt,
            end_dt,
            strt_tm,
            end_tm,
            max_nop_cnt,
            rsv_cnt,
            stts_cd,
            description,
            reg_dt,
            upd_dt
        ) VALUES (
            #{brchId},
            #{progId},
            #{usrId},
            #{strtDt},
            #{endDt},
            #{strtTm},
            #{endTm},
            #{maxNopCnt},
            #{rsvCnt},
            #{sttsCd},
            #{description},
            #{regDt},
            #{updDt}
        )
    </insert>

    <!-- =========================
         스케줄 수정
    ========================= -->
    <update id="update"
            parameterType="com.project.app.schedule.domain.Schedule">
        UPDATE schedule
        SET
            brch_id = #{brchId},
            prog_id = #{progId},
            usr_id = #{usrId},
            strt_dt = #{strtDt},
            end_dt = #{endDt},
            strt_tm = #{strtTm},
            end_tm = #{endTm},
            max_nop_cnt = #{maxNopCnt},
            stts_cd = #{sttsCd},
            description = #{description},
            upd_dt = #{updDt}
        WHERE schd_id = #{schdId}
    </update>

    <!-- =========================
         스케줄 삭제
    ========================= -->
    <delete id="delete"
            parameterType="long">
        DELETE FROM schedule
        WHERE schd_id = #{schdId}
    </delete>

    <!-- =========================
         중복 체크 (같은 날짜, 시간, 프로그램, 강사)
    ========================= -->
    <select id="countDuplicate"
            resultType="int">
        SELECT COUNT(*)
        FROM schedule
        WHERE prog_id = #{progId}
          AND usr_id = #{usrId}
          AND strt_dt = #{strtDt}
          AND (
            (strt_tm &lt; #{endTm} AND end_tm &gt; #{strtTm})
          )
          <if test="excludeSchdId != null">
            AND schd_id != #{excludeSchdId}
          </if>
    </select>

</mapper>

