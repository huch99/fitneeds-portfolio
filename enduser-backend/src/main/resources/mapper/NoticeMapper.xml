<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.notice.mapper.NoticeMapper">

    <!-- =========================
         USER ê³µì§€ ëª©ë¡ ì¡°íšŒ
         - ìˆ¨ê¹€ ì œì™¸
         - ì¢…ë£Œëœ ê³µì§€ ì œì™¸
         - ìƒì‹œ ê³µì§€ëŠ” ìœ ì§€
         - ì§€ì ëª…(branchName) JOIN
         - ðŸ”¥ ìƒë‹¨ ê³ ì •(is_pinned) ìš°ì„  ì •ë ¬
    ========================= -->
    <select id="selectNoticeList"
            resultType="com.project.app.notice.dto.NoticeDto">

        SELECT
            cp.post_id      AS postId,
            cp.title        AS title,
            cp.content      AS content,
            cp.views        AS views,
            cp.display_end  AS displayEnd,
            cp.created_at   AS createdAt,
            cp.branch_id    AS branchId,
            cp.is_pinned    AS isPinned,
            b.brch_nm       AS branchName
        FROM COMMUNITY_POST cp
        LEFT JOIN BRANCH b
            ON cp.branch_id = b.brch_id
        WHERE cp.post_type = 'NOTICE'
          AND cp.is_visible = 1
          AND (
                cp.display_end IS NULL
                OR cp.display_end >= NOW()
          )
        ORDER BY
            cp.is_pinned DESC,     <!-- ðŸ”¥ ìƒë‹¨ ê³ ì • ë¨¼ì € -->
            cp.created_at DESC    <!-- ê·¸ ë‹¤ìŒ ìµœì‹ ìˆœ -->

    </select>

    <!-- =========================
         USER ê³µì§€ ìƒì„¸ ì¡°íšŒ
         - ìˆ¨ê¹€ ì œì™¸
         - ì¢…ë£Œëœ ê³µì§€ ì ‘ê·¼ ë¶ˆê°€
         - ì§€ì ëª…(branchName) JOIN
    ========================= -->
    <select id="selectNoticeDetail"
            parameterType="long"
            resultType="com.project.app.notice.dto.NoticeDto">

        SELECT
            cp.post_id      AS postId,
            cp.title        AS title,
            cp.content      AS content,
            cp.views        AS views,
            cp.display_end  AS displayEnd,
            cp.created_at   AS createdAt,
            cp.branch_id    AS branchId, 
            b.brch_nm       AS branchName
        FROM COMMUNITY_POST cp
        LEFT JOIN BRANCH b
            ON cp.branch_id = b.brch_id
        WHERE cp.post_id = #{postId}
          AND cp.post_type = 'NOTICE'
          AND cp.is_visible = 1
          AND (
                cp.display_end IS NULL
                OR cp.display_end >= NOW()
          )

    </select>

    <!-- =========================
         ì¡°íšŒìˆ˜ ì¦ê°€
         - ìˆ¨ê¹€/ì¢…ë£Œ ê³µì§€ëŠ” ì¦ê°€ ì•ˆ ë¨
    ========================= -->
    <update id="increaseViews" parameterType="long">

        UPDATE COMMUNITY_POST
        SET views = IFNULL(views, 0) + 1,
            updated_at = NOW()
        WHERE post_id = #{postId}
          AND post_type = 'NOTICE'
          AND is_visible = 1
          AND (
                display_end IS NULL
                OR display_end >= NOW()
          )

    </update>

</mapper>
