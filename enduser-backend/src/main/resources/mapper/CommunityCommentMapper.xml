<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.community.mapper.CommunityCommentMapper">

    <!--
        USER ÎåìÍ∏Ä Î™©Î°ù Ï°∞Ìöå
        - ÌäπÏ†ï Í≤åÏãúÍ∏Ä(postId)Ïóê ÎåÄÌïú ÎåìÍ∏Ä
        - Ïà®ÍπÄ Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ ÎåìÍ∏ÄÎßå Ï°∞Ìöå
        - comment_visible = 1
    -->
    <select id="selectVisibleCommentsByPostId"
            parameterType="long"
            resultType="com.project.app.community.dto.CommunityCommentDto">

        SELECT
            c.comment_id    AS commentId,
            c.post_id       AS postId,
            c.writer_id     AS writerId,
            COALESCE(u.user_name, 'ÌÉàÌá¥Ìïú ÌöåÏõê') AS writerName,
            c.writer_type   AS writerType,
            c.content,
            c.created_at    AS createdAt
        FROM COMMUNITY_COMMENT c
        LEFT JOIN USERS u
               ON u.user_id = c.writer_id
        WHERE c.post_id = #{postId}
          AND c.comment_visible = 1
        ORDER BY c.comment_id ASC

    </select>

    <!-- =========================
         üîí ÎåìÍ∏Ä ÏûëÏÑ±Ïûê Î≥∏Ïù∏ Ïó¨Î∂Ä Ï≤¥ÌÅ¨
         ========================= -->
    <select id="countByCommentIdAndWriterId"
            resultType="int">
        SELECT COUNT(*)
        FROM COMMUNITY_COMMENT
        WHERE comment_id = #{commentId}
          AND writer_id = #{writerId}
          AND comment_visible = 1
    </select>

	<!-- =========================
         ‚úèÔ∏è ÎåìÍ∏Ä ÏàòÏ†ï (Î≥∏Ïù∏Îßå)
         ========================= -->
    <update id="updateCommentContent">
        UPDATE COMMUNITY_COMMENT
        SET
            content = #{content}
        WHERE comment_id = #{commentId}
          AND writer_id = #{writerId}
          AND comment_visible = 1
    </update>

	<!-- =========================
         üóë ÎåìÍ∏Ä ÏÇ≠Ï†ú (Î≥∏Ïù∏Îßå)
         ========================= -->
    <delete id="deleteCommentByWriter">
        DELETE
        FROM COMMUNITY_COMMENT
        WHERE comment_id = #{commentId}
          AND writer_id = #{writerId}
    </delete>

</mapper>
