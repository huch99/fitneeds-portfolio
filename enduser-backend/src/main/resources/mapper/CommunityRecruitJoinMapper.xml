<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.community.mapper.CommunityRecruitJoinMapper">

  <!-- =========================
       Ï∞∏Ïó¨ Ïã†Ï≤≠ Ï§ëÎ≥µ Ï≤¥ÌÅ¨
       post_id + user_id Í∏∞Ï§Ä
  ========================= -->
  <select id="countByPostIdAndUserId" resultType="int">
    SELECT COUNT(*)
    FROM COMMUNITY_RECRUIT_JOIN
    WHERE post_id = #{postId}
      AND user_id = #{userId}
  </select>

  <!-- =========================
       Î™®Ïßë Ï∞∏Ïó¨ Ïù∏Ïõê Ïàò Ï°∞Ìöå
  ========================= -->
  <select id="countByPostId" resultType="int">
    SELECT COUNT(*)
    FROM COMMUNITY_RECRUIT_JOIN
    WHERE post_id = #{postId}
  </select>

  <!-- =========================
       Ï∞∏Ïó¨ Ïã†Ï≤≠ INSERT
  ========================= -->
  <insert id="insertRecruitJoin">
    INSERT INTO COMMUNITY_RECRUIT_JOIN (
      post_id,
      user_id,
      join_type
    ) VALUES (
      #{postId},
      #{userId},
      'JOIN'
    )
  </insert>

  <!-- =========================
       Ï∞∏Ïó¨ Ï∑®ÏÜå DELETE
  ========================= -->
  <delete id="deleteRecruitJoin">
    DELETE
    FROM COMMUNITY_RECRUIT_JOIN
    WHERE post_id = #{postId}
      AND user_id = #{userId}
  </delete>

  <!-- =========================
       Ï∞∏Ïó¨ Ïã†Ï≤≠Ïûê Î™©Î°ù Ï°∞Ìöå
       (ÏûëÏÑ±ÏûêÏö©)
       üî• user_id ‚Üí user_name
  ========================= -->
  <select id="selectJoinUsersByPostId" resultType="string">
    SELECT COALESCE(u.user_name, 'ÌÉàÌá¥Ìïú ÌöåÏõê')
    FROM COMMUNITY_RECRUIT_JOIN j
    LEFT JOIN USERS u
           ON u.user_id = j.user_id
    WHERE j.post_id = #{postId}
    ORDER BY j.join_id ASC
  </select>

  <!-- =========================
       üî• ÎÇ¥Í∞Ä Ï∞∏Ïó¨Ìïú Î™®Ïßë Í∏Ä Î™©Î°ù Ï°∞Ìöå
       (USER Ï†ÑÏö©)
       ‚Äª Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ
  ========================= -->
  <select id="selectMyJoinedRecruitPosts"
          parameterType="string"
          resultType="com.project.app.community.dto.CommunityPostDto">

    SELECT
      p.post_id            AS postId,
      p.title              AS title,
      p.category           AS category,
      p.writer_id          AS writerId,
      p.created_at         AS createdAt,
      p.recruit_end_date   AS recruitEndDate,
      p.recruit_max        AS recruitMax,
      p.sport_type         AS sportType,

      /* üî• ÌòÑÏû¨ Ï∞∏Ïó¨ Ïù∏Ïõê Ïàò */
      COUNT(crj.join_id)   AS recruitCount

    FROM COMMUNITY_RECRUIT_JOIN j
    JOIN COMMUNITY_POST p
      ON j.post_id = p.post_id
    LEFT JOIN COMMUNITY_RECRUIT_JOIN crj
      ON crj.post_id = p.post_id

    WHERE j.user_id = #{userId}
      AND p.category = 'Î™®Ïßë'
      AND p.post_visible = 1

    GROUP BY p.post_id
    ORDER BY j.join_id DESC
  </select>

</mapper>
