<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.community.mapper.CommunityPostDetailMapper">

  <!-- Ïª§ÎÆ§ÎãàÌã∞ Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå (USER) -->
  <select id="selectVisiblePostDetail"
          resultType="com.project.app.community.dto.CommunityPostDto">
    SELECT
      cp.post_id          AS postId,
      cp.post_type        AS postType,
      cp.category,
      cp.title,
      cp.content,
      cp.writer_id        AS writerId,
      COALESCE(u.user_name, 'ÌÉàÌá¥Ìïú ÌöåÏõê') AS writerName,
      cp.writer_type      AS writerType,
      cp.branch_id        AS branchId,
      cp.views,
      cp.created_at       AS createdAt,
      cp.updated_at       AS updatedAt,
      cp.sport_type       AS sportType,
      cp.recruit_max      AS recruitMax,
      cp.recruit_end_date AS recruitEndDate
    FROM COMMUNITY_POST cp
    LEFT JOIN USERS u
           ON u.user_id = cp.writer_id
    WHERE cp.post_id = #{postId}
      AND cp.post_visible = 1
  </select>

  <!-- üî• Ïª§ÎÆ§ÎãàÌã∞ Í≤åÏãúÍ∏Ä Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä (USER Ï†ÑÏö©, Ï§ëÎ≥µ ÌóàÏö©) -->
  <update id="increaseViewCount">
    UPDATE COMMUNITY_POST
    SET views = views + 1
    WHERE post_id = #{postId}
      AND post_visible = 1
  </update>

  <!-- Ïª§ÎÆ§ÎãàÌã∞ ÎåìÍ∏Ä Î™©Î°ù Ï°∞Ìöå (USER) -->
  <select id="selectVisibleCommentsByPostId"
          resultType="com.project.app.community.dto.CommunityCommentDto">
		SELECT
		c.comment_id AS commentId,
		c.post_id AS postId,
		c.writer_id AS writerId,
		COALESCE(u.user_name, 'ÌÉàÌá¥Ìïú ÌöåÏõê') AS writerName,
		c.writer_type AS writerType,
		c.content,
		c.created_at AS createdAt
		FROM COMMUNITY_COMMENT c
		LEFT JOIN USERS u
		ON u.user_id = c.writer_id
		WHERE c.post_id = #{postId}
		AND c.comment_visible = 1
		ORDER BY c.comment_id ASC

  </select>

  <!-- Ïª§ÎÆ§ÎãàÌã∞ ÎåìÍ∏Ä ÏûëÏÑ± (USER) -->
  <insert id="insertComment">
    INSERT INTO COMMUNITY_COMMENT (
      post_id,
      writer_id,
      writer_type,
      content,
      comment_visible,
      created_at
    ) VALUES (
      #{postId},
      #{writerId},
      #{writerType},
      #{content},
      1,
      NOW()
    )
  </insert>

</mapper>
