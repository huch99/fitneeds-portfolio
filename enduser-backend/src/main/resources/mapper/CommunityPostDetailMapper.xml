<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.community.mapper.CommunityPostDetailMapper">

  <!-- ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ (USER) -->
  <select id="selectVisiblePostDetail"
          resultType="com.project.app.community.dto.CommunityPostDto">
    SELECT
      cp.post_id          AS postId,
      cp.post_type        AS postType,
      cp.category,
      cp.title,
      cp.content,
      cp.writer_id        AS writerId,
      u.user_name         AS writerName,   <!-- ðŸ”¥ ì´ ì¤„ì´ í•µì‹¬ -->
      cp.writer_type      AS writerType,
      cp.branch_id        AS branchId,
      cp.views,
      cp.created_at       AS createdAt,
      cp.updated_at       AS updatedAt,
      cp.sport_type       AS sportType,
      cp.recruit_max      AS recruitMax,
      cp.recruit_end_date AS recruitEndDate
    FROM COMMUNITY_POST cp
    LEFT JOIN USERS u
           ON u.user_id = cp.writer_id
    WHERE cp.post_id = #{postId}
      AND cp.post_visible = 1
  </select>

  <!-- ðŸ”¥ ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€ ì¡°íšŒìˆ˜ ì¦ê°€ (USER ì „ìš©, ì¤‘ë³µ í—ˆìš©) -->
  <update id="increaseViewCount">
    UPDATE COMMUNITY_POST
    SET views = views + 1
    WHERE post_id = #{postId}
      AND post_visible = 1
  </update>

  <!-- ì»¤ë®¤ë‹ˆí‹° ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (USER) -->
  <select id="selectVisibleCommentsByPostId"
          resultType="com.project.app.community.dto.CommunityCommentDto">
		SELECT
		c.comment_id AS commentId,
		c.post_id AS postId,
		c.writer_id AS writerId,
		u.user_name AS writerName, -- ðŸ”¥ í•µì‹¬
		c.writer_type AS writerType,
		c.content,
		c.created_at AS createdAt
		FROM COMMUNITY_COMMENT c
		LEFT JOIN USERS u
		ON u.user_id = c.writer_id
		WHERE c.post_id = #{postId}
		AND c.comment_visible = 1
		ORDER BY c.comment_id ASC

  </select>

  <!-- ì»¤ë®¤ë‹ˆí‹° ëŒ“ê¸€ ìž‘ì„± (USER) -->
  <insert id="insertComment">
    INSERT INTO COMMUNITY_COMMENT (
      post_id,
      writer_id,
      writer_type,
      content,
      comment_visible,
      created_at
    ) VALUES (
      #{postId},
      #{writerId},
      #{writerType},
      #{content},
      1,
      NOW()
    )
  </insert>

</mapper>
