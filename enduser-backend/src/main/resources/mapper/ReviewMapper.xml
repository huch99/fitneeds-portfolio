<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.review.mapper.ReviewMapper">

    <!-- 중복 리뷰 체크 -->
    <select id="existsByReservationId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM review
        WHERE reservation_id = #{reservationId}
          AND deleted = false
    </select>

    <!-- 리뷰 작성 -->
    <insert id="insertReview">
        INSERT INTO review (
            reservation_id,
            rating,
            content,
            user_id,
            deleted,
            reg_dt
        ) VALUES (
            #{reservationId},
            #{rating},
            #{content},
            #{userId},
            false,
            NOW()
        )
    </insert>

    <!-- 내 리뷰 목록 -->
    <select id="selectReviewsByUserId"
            resultType="com.project.app.review.dto.ReviewResponse">
        SELECT
            review_id AS reviewId,
            reservation_id AS reservationId,
            rating,
            content,
            instructor_id AS instructorId,
            reg_dt AS registrationDateTime
        FROM review
        WHERE user_id = #{userId}
          AND deleted = false
        ORDER BY reg_dt DESC
    </select>

    <!-- 리뷰 단건 조회 -->
    <select id="selectReviewById"
            resultType="com.project.app.review.dto.ReviewResponse">
        SELECT
            review_id AS reviewId,
            reservation_id AS reservationId,
            rating,
            content,
            instructor_id AS instructorId,
            reg_dt AS registrationDateTime
        FROM review
        WHERE review_id = #{reviewId}
          AND deleted = false
    </select>

    <!-- 리뷰 수정 (본인만) -->
    <update id="updateReview">
        UPDATE review
        SET
            rating = #{rating},
            content = #{content}
        WHERE review_id = #{reviewId}
          AND user_id = #{userId}
          AND deleted = false
    </update>

    <!-- 리뷰 삭제 (소프트 삭제, 본인만) -->
    <update id="deleteReview">
        UPDATE review
        SET deleted = true
        WHERE review_id = #{reviewId}
          AND user_id = #{userId}
    </update>

</mapper>


