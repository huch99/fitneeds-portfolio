<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.app.review.mapper.ReviewMapper">

    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="ReviewDto" useGeneratedKeys="true" keyProperty="reviewId">
        INSERT INTO REVIEW (
            rsv_id, rating, content, inst_id, reg_dt
        ) VALUES (
            #{reservationId}, #{rating}, #{content}, #{userId}, NOW()
        )
    </insert>

    <!-- 내가 쓴 리뷰 목록 조회 -->
    <select id="selectMyReviewList" parameterType="String" resultType="ReviewDto">
        SELECT 
            r.rvw_id as reviewId,
            r.rsv_id as reservationId,
            r.rating,
            r.content,
            r.inst_id as userId,
            r.reg_dt as createdAt,
            true as isWriter
        FROM REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        WHERE res.user_id = #{userId}
        ORDER BY r.reg_dt DESC
    </select>

    <!-- 예약 ID로 리뷰 조회 -->
    <select id="selectReviewByReservationId" resultType="ReviewDto">
        SELECT 
            r.rvw_id as reviewId,
            r.rsv_id as reservationId,
            r.rating,
            r.content,
            r.inst_id as userId,
            r.reg_dt as createdAt,
            CASE WHEN res.user_id = #{userId} THEN true ELSE false END as isWriter
        FROM REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        WHERE r.rsv_id = #{reservationId}
        ORDER BY r.reg_dt DESC
    </select>

    <!-- 이용내역 ID로 리뷰 조회 -->
    <select id="selectReviewByHistoryId" resultType="ReviewDto">
        SELECT 
            r.rvw_id as reviewId,
            r.rsv_id as reservationId,
            r.rating,
            r.content,
            r.inst_id as userId,
            r.reg_dt as createdAt,
            CASE WHEN res.user_id = #{userId} THEN true ELSE false END as isWriter
        FROM REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        WHERE r.rsv_id = #{historyId}
        ORDER BY r.reg_dt DESC
    </select>

    <!-- 리뷰 상세 조회 -->
    <select id="selectReviewDetail" parameterType="Long" resultType="ReviewDto">
        SELECT 
            r.rvw_id as reviewId,
            r.rsv_id as reservationId,
            r.rating,
            r.content,
            r.inst_id as userId,
            r.reg_dt as createdAt
        FROM REVIEW r
        WHERE r.rvw_id = #{reviewId}
    </select>

    <!-- 리뷰 작성자 본인 여부 체크 -->
    <select id="countByReviewIdAndUserId" resultType="int">
        SELECT COUNT(*)
        FROM REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        WHERE r.rvw_id = #{reviewId}
        AND res.user_id = #{userId}
    </select>

    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="ReviewDto">
        UPDATE REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        SET 
            r.rating = #{rating},
            r.content = #{content}
        WHERE r.rvw_id = #{reviewId}
        AND res.user_id = #{userId}
    </update>

    <!-- 리뷰 삭제 -->
    <delete id="deleteReview">
        DELETE r FROM REVIEW r
        JOIN RESERVATION res ON r.rsv_id = res.rsv_id
        WHERE r.rvw_id = #{reviewId}
    </delete>

</mapper>